# intel-media-driver-25.3.4-install-script
Скрипт автоматической сборки медиа драйвера для встроенной графики Intel под Debian (Proxmox)
Это bash-скрипт для полной автоматизации установки Intel Media Driver 25.3.4.  
Сохраните его в файл install_intel_media_driver.sh, сделайте исполняемым (chmod +x install_intel_media_driver.sh) и запустите (./install_intel_media_driver.sh). Работайте от root или с sudo.
После установки перезагрузите систему (reboot) и протестируйте: vainfo должен отобразить поддерживаемые форматы видео (например, HEVC, AV1).

Установка драйвера Intel Media Driver версии 25.3.4 на Proxmox VE 8.4.14 для поддержки встроенной графики Intel Alder Lake-N (ADL-N) в процессоре Intel N150 (Twin Lake) или аналогичного требует компиляции из исходных кодов, поскольку в стандартных репозиториях Proxmox (основанных на Debian 12 Bookworm) эти драйверы отсутствуют. Это позволяет включить аппаратное ускорение видео (VAAPI) для декодирования, кодирования и постобработки, что полезно для задач виртуализации, таких как передача iGPU в виртуальные машины или транскодирование медиа на хосте. Драйвер поддерживает платформы вроде ADL-N, обеспечивая работу с форматами AV1, HEVC и VP9. Для продвинутых функций кодирования (например, контроль битрейта CBR/VBR) требуется прошивка HuC, которая обычно доступна в ядрах Linux 6.2+

Процесс установки включает три ключевых компонента: gmmlib (библиотека управления памятью графики), libva (API ускорения видео) и сам media-driver. Эти компоненты взаимозависимы: gmmlib обеспечивает выделение памяти для GPU, libva предоставляет интерфейс API, а media-driver реализует аппаратную часть.

Перед запуском убедитесь, что Proxmox обновлён и имеет доступ к интернету для git и apt. Работайте от root или с sudo. Создайте резервную копию системы, поскольку установка из исходников может перезаписать пакетированные библиотеки, потенциально повлияв на другие пользователи VAAPI (например, устаревший i965). Если в Proxmox есть конфликтующие модули ядра с DRM (Direct Rendering Manager), выгрузите их через modprobe -r.
Зависимости для сборки сочетают требования всех репозиториев и устанавливаются в скрипте:

git, cmake, pkg-config, meson для инструментов сборки.
libdrm-dev, automake, libtool, autoconf для доступа к графике.
xorg, xorg-dev, openbox, libx11-dev, libgl1-mesa-glx, libxfixes-dev для библиотек дисплея.
vainfo для проверки.

Эти пакеты доступны в репозиториях Debian/Proxmox; если чего-то не хватает, добавьте вручную через apt install.
Детальный процесс сборки в скрипте
Исправленный скрипт автоматизирует все шаги, включая правильный checkout для libva. Он использует режим Release для оптимизации;

Все шаги:

gmmlib: Клонирование репозитория https://github.com/intel/gmmlib.git, checkout тега "intel-gmmlib-22.8.2", создание директории build, конфигурация CMake, компиляция с make -j$(nproc) и установка. Устанавливается в /usr/local/lib (например, libigdgmm.so). Эта библиотека критически важна для управления памятью в GPU и совместима с ABI media-driver 25.x.
libva: Клонирование https://github.com/intel/libva.git, checkout "2.22.0" (исправленный шаг), autogen с путями для Debian (--prefix=/usr --libdir=/usr/lib/x86_64-linux-gnu) чтобы избежать проблем с LD_LIBRARY_PATH, компиляция и установка. Альтернатива — использовать Meson (meson .. -Dprefix=/usr -Dlibdir=/usr/lib/x86_64-linux-gnu && ninja && sudo ninja install), но autogen стандартный для старых конфигураций. Эта библиотека предоставляет VA-API, интерфейс для аппаратного ускорения видео.
media-driver: Клонирование https://github.com/intel/media-driver.git, checkout "intel-media-25.3.4", создание build, CMake, компиляция и установка. Устанавливает драйвер iHD (iHD_drv_video.so) в /usr/lib/x86_64-linux-gnu/dri и скрипт профиля для окружения. Для ADL-N это обеспечивает полную поддержку, включая AV1-декодирование и HEVC-кодирование.

Скрипт также создаёт файл /etc/profile.d/intel-media.sh для переменных окружения (LIBVA_DRIVERS_PATH и LIBVA_DRIVER_NAME=iHD), очищает временные файлы и выводит сообщение об успешном завершении.

Настройка после установки:
После выполнения скрипта источник профиля: source /etc/profile.d/intel-media.sh. Если файл не создан автоматически, добавьте переменные вручную в /etc/environment:
textLIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
LIBVA_DRIVER_NAME=iHD
Перезагрузка системы (reboot) применит изменения ко всем сессиям. Для постоянства убедитесь, что переменные загружаются при старте.
